<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Elektriker Notdienst MÃ¼nchen âš¡ QR-Zahlung</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body { font-family:'Montserrat',sans-serif; margin:0; background:#f5f5f5; color:#222; line-height:1.6; }
header { background:linear-gradient(135deg,#111,#333); color:white; text-align:center; padding:60px 15px; }
header h1 { color:#FFD000; font-size:2.2em; margin-bottom:10px; }
header p { font-size:1.2em; }
section { text-align:center; padding:40px 15px; }
.btn { display:inline-block; margin:10px 5px; padding:18px 35px; font-weight:700; text-decoration:none; border-radius:50px; font-size:1.2em; transition:all 0.3s ease; cursor:pointer; background:#25D366; color:white; }
.btn:hover { transform:scale(1.05); background:#1ebe57; }
#qr-code { margin-top:20px; max-width:300px; }
#payment-status { margin-top:15px; font-weight:bold; color:green; font-size:1.2em; }
</style>
</head>
<body>

<header>
<h1>âš¡ Elektriker Notdienst MÃ¼nchen 24h</h1>
<p>Zahlen & Videochat starten per QR-Code</p>
</header>

<section>
<button id="start-btn" class="btn">ðŸ’³ Zahlung & QR-Code generieren</button>

<div>
  <img id="qr-code" src="" alt="QR-Code" style="display:none;">
  <div id="payment-status"></div>
</div>
</section>

<footer style="text-align:center; padding:20px; background:#111; color:white;">
<p>Â© 2026 Elektriker Notdienst MÃ¼nchen</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
// Funktion um eine Rechnungsnummer zu erzeugen
function generateInvoiceNumber(){
  const date = new Date();
  return 'INV-'+date.getFullYear()+('0'+(date.getMonth()+1)).slice(-2)+('0'+date.getDate()).slice(-2)+'-'+Math.floor(Math.random()*9000+1000);
}

const startBtn = document.getElementById('start-btn');
const qrImg = document.getElementById('qr-code');
const statusDiv = document.getElementById('payment-status');

startBtn.addEventListener('click', async ()=>{
  startBtn.disabled = true;
  const invoice = generateInvoiceNumber();
  
  // QR-Code generieren (hier demo-URL mit Rechnungsnummer)
  const paymentUrl = `/create-qr-payment?invoice=${invoice}`; // Backend erzeugt echten Stripe Payment Link mit invoice
  const qrDataUrl = await QRCode.toDataURL(paymentUrl, { width: 300 });
  
  qrImg.src = qrDataUrl;
  qrImg.style.display = 'inline-block';
  statusDiv.textContent = "Bitte QR-Code scannen und bezahlen...";

  // Polling Paymentstatus
  const checkPayment = async ()=>{
    const res = await fetch(`/check-payment-status?invoice=${invoice}`);
    const data = await res.json();
    if(data.paid){
      qrImg.style.display = "none";
      statusDiv.textContent = "âœ… Zahlung erfolgreich! Videochat wird gestartet...";
      setTimeout(()=>{
        window.location.href = "https://wa.me/4915145932462?text=Hallo%20ich%20brauche%20Hilfe%20bei%20einem%20Stromproblem";
      },2000);
    } else {
      setTimeout(checkPayment,5000);
    }
  };
  checkPayment();
});
</script>
</body>
</html>
