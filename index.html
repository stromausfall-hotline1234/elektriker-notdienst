<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KI-Notdienst – Strom, Wasser & Heizung</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body{margin:0;font-family:'Montserrat',sans-serif;background:#f0f2f5;color:#222;}
h1,h2,h3{margin:0 0 15px;}
button{padding:12px 20px;border:none;border-radius:8px;background:#25d366;color:white;cursor:pointer;transition:0.3s;font-weight:600;}
button:disabled{opacity:0.5;cursor:not-allowed;}
button:hover:not(:disabled){background:#1ebe57;}
nav{display:flex;justify-content:flex-end;gap:25px;padding:15px 20px;background:white;box-shadow:0 2px 8px rgba(0,0,0,0.05);}
nav a{color:#222;text-decoration:none;font-weight:600;cursor:pointer;}
nav a:hover{color:#25d366;}
header{padding:30px 20px;text-align:center;}
header button{font-size:1.1em;}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;z-index:1000;padding:10px;}
.modal-content{background:white;padding:20px;border-radius:12px;max-width:600px;width:100%;max-height:90vh;overflow:auto;box-shadow:0 6px 15px rgba(0,0,0,0.1);}
input,textarea,select{width:100%;padding:10px;margin:6px 0;border:1px solid #ccc;border-radius:8px;box-sizing:border-box;}
#messages{height:250px;overflow-y:auto;border:1px solid #ccc;padding:10px;margin:10px 0;border-radius:8px;background:white;}
.message{padding:6px 10px;border-radius:10px;margin-bottom:5px;word-break:break-word;}
.message.user{background:#25d366;color:white;text-align:right;}
.message.ai{background:#ffca28;color:#111;text-align:left;}
#progressContainer{width:100%;background:#ddd;border-radius:8px;overflow:hidden;margin:10px 0;}
#progressBar{width:0%;height:15px;background:#25d366;}
#countdown{font-weight:bold;margin-bottom:10px;}
footer{padding:15px;text-align:center;background:#111;color:#ffca28;font-size:14px;}
footer a{color:#ffca28;text-decoration:none;margin:0 8px;}
footer a:hover{text-decoration:underline;}
#startSpeechBtn{width:50px;padding:10px;text-align:center;font-size:18px;}
.feature-section{padding:40px 20px;background:#fff;}
.feature-section h2{text-align:center;margin-bottom:30px;font-size:2em;}
.feature-cards{display:flex; flex-wrap:wrap; justify-content:center; gap:20px;}
.feature-card{flex:1 1 250px; max-width:300px; background:#f7f7f7; border-radius:12px; padding:20px; box-shadow:0 4px 15px rgba(0,0,0,0.1); text-align:center; transition:0.3s; cursor:pointer;}
.feature-card:hover{transform:translateY(-5px); box-shadow:0 8px 20px rgba(0,0,0,0.15);}
.feature-card svg{width:50px; height:50px; margin-bottom:15px;}
@media(max-width:900px){.feature-card{flex:1 1 45%;}}
@media(max-width:600px){.feature-card{flex:1 1 100%;}}
</style>
</head>
<body>

<nav>
  <a href="impressum.html" target="_blank">Impressum</a>
  <a href="datenschutz.html" target="_blank">Datenschutz</a>
  <a href="agb.html" target="_blank">AGB</a>
</nav>

<header>
<h1>⚡ KI-Notdienst – Strom, Wasser & Heizung</h1>
<p>Starten Sie die Soforthilfe mit Ihrem persönlichen Zugang.</p>
<button id="openCustomerBtn">Soforthilfe anfordern – 39,99 €</button>
</header>

<section class="feature-section">
<h2>Unsere Leistungen auf einen Blick</h2>
<div class="feature-cards">
  <div class="feature-card">
    <svg fill="#25d366" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M11 21h-1l1-7H8l5-12v7h3l-5 12z"/></svg>
    <h3>Elektrik-Notdienst</h3>
    <p>Schnelle Hilfe bei Stromausfall, FI-Schalter oder Sicherungsproblemen – direkt per KI-Triage analysiert.</p>
  </div>
  <div class="feature-card">
    <svg fill="#00bfff" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2.69l5.66 5.66C18.36 10.3 16.21 14.27 12 21c-4.21-6.73-6.36-10.7-5.66-12.65L12 2.69z"/></svg>
    <h3>Wasser-Notdienst</h3>
    <p>Rohrbrüche, Lecks oder Pumpenausfälle – wir analysieren Ihr Problem sofort und leiten es an einen Fachmann weiter.</p>
  </div>
  <div class="feature-card">
    <svg fill="#ff8c00" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 3.865-3.134 7-7 7S5 12.865 5 9a7 7 0 0 1 7-7zm0 12c-5 0-9 2.5-9 5v1h18v-1c0-2.5-4-5-9-5z"/></svg>
    <h3>Heizungs-Notdienst</h3>
    <p>Heizungsausfall oder ungleichmäßige Wärme? Unsere KI erkennt das Problem und unterstützt den Fachmann-Einsatz.</p>
  </div>
  <div class="feature-card">
    <svg fill="#8a2be2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17.93V20h-2v-.07A8.001 8.001 0 0 1 4.07 13H6v-2H4.07A8.001 8.001 0 0 1 11 4.07V6h2V4.07A8.001 8.001 0 0 1 19.93 11H18v2h1.93A8.001 8.001 0 0 1 13 19.93z"/></svg>
    <h3>KI-gestützte Analyse</h3>
    <p>Unsere KI-Triage erkennt Notfälle frühzeitig, sammelt Informationen und bereitet die Weiterleitung an Experten vor.</p>
  </div>
</div>
</section>

<!-- Kundendaten Modal -->
<div class="modal" id="customerModal">
<div class="modal-content">
<h2>Notdienst Anfrage</h2>
<input id="name" placeholder="Vor- und Nachname">
<input id="address" placeholder="Adresse">
<input id="phone" placeholder="Telefonnummer">
<input id="email" placeholder="E-Mail-Adresse">
<label><input type="checkbox" id="consent"> Ich akzeptiere die <a href="#" onclick="showInfo('datenschutz','modalInfoBoxCustomer');return false;">Datenschutzerklärung</a></label>
<div id="modalInfoBoxCustomer" class="info-box"></div>
<hr>
<label for="serviceType">Service-Typ auswählen:</label>
<select id="serviceType">
  <option value="">-- Bitte wählen --</option>
  <option value="electricity">Elektrik</option>
  <option value="water">Wasser</option>
  <option value="heating">Heizung</option>
</select>
<button id="startKiBtn" disabled>KI-Triage starten</button>
<button onclick="closeCustomerModal()">Zurück</button>
</div>
</div>

<!-- KI Chat Modal -->
<div class="modal" id="kiModal">
<div class="modal-content">
<h2>KI-Assistenz</h2>
<div class="info-box" style="display:block;">⚠ Die KI sammelt Informationen für den Fachmann. Arbeiten können gefährlich sein.</div>
<div id="messages"></div>
<div id="kiAssessmentCard" class="feature-card" style="display:none;">
  <svg id="kiAssessmentIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"></svg>
  <h3 id="kiAssessmentTitle"></h3>
  <p id="kiAssessmentText"></p>
</div>
<button id="bookVideoCallBtn" style="display:none; background:#ff4500;">Videocall buchen – 19,99 €</button>
<input type="text" id="userInput" placeholder="Beschreiben Sie Ihr Problem...">
<button id="sendBtn">Senden</button>
<input type="file" id="fileInputKI" accept="image/*" multiple><br>
<div id="countdown">02:00</div>
<div id="progressContainer"><div id="progressBar"></div></div>
</div>
</div>

<!-- Fachmann Modal -->
<div class="modal" id="expertModal">
<div class="modal-content">
<h2>Fachmann-Bestätigung</h2>
<p>Der Fachmann wird Sie nun kontaktieren.</p>
<label>Schwierigkeitsgrad Bewertung:</label>
<select id="difficultyLevel">
  <option value="1">1 – Leicht</option>
  <option value="2">2 – Mittel</option>
  <option value="3">3 – Komplex</option>
  <option value="4">4 – Kritisch</option>
</select>
<button id="confirmExpertBtn">WhatsApp kontaktieren</button>
<button onclick="closeExpertModal()">Zurück</button>
</div>
</div>

<footer>
© 2026 KI-Notdienst
</footer>

<script type="module">
import { supabase } from './supabase.js'

// Rechtstexte
const infoTexts={datenschutz:`<strong>Datenschutzerklärung</strong><br>Wir speichern Ihre Daten ausschließlich für Rückruf und Video-Beratung. Weitergabe an Dritte erfolgt nicht.`};
function showInfo(type,id){document.getElementById(id).innerHTML=infoTexts[type]+`<br><button onclick="this.parentElement.style.display='none'">Schließen</button>`; document.getElementById(id).style.display='block';}

// Elemente
const customerModal=document.getElementById("customerModal");
const openCustomerBtn=document.getElementById("openCustomerBtn");
const nameEl=document.getElementById("name");
const addressEl=document.getElementById("address");
const phoneEl=document.getElementById("phone");
const emailEl=document.getElementById("email");
const consentEl=document.getElementById("consent");
const serviceTypeEl=document.getElementById("serviceType");
const startKiBtn=document.getElementById("startKiBtn");

const kiModal=document.getElementById("kiModal");
const messagesEl=document.getElementById("messages");
const userInputEl=document.getElementById("userInput");
const sendBtn=document.getElementById("sendBtn");
const fileInputKI=document.getElementById("fileInputKI");
const progressBar=document.getElementById("progressBar");
const countdownEl=document.getElementById("countdown");

const expertModal=document.getElementById("expertModal");
const confirmExpertBtn=document.getElementById("confirmExpertBtn");
const bookVideoCallBtn=document.getElementById("bookVideoCallBtn");

let uploadedImages = []

document.addEventListener("DOMContentLoaded", ()=>{
  // Soforthilfe Button
  openCustomerBtn.addEventListener("click",()=>customerModal.style.display="flex")

  // Start KI Button Aktivierung
  [nameEl,addressEl,phoneEl,emailEl,consentEl,serviceTypeEl].forEach(el=>{
    el.addEventListener("input",updateStartKiBtn)
    el.addEventListener("change",updateStartKiBtn)
  });
  function updateStartKiBtn(){startKiBtn.disabled=!(nameEl.value && addressEl.value && phoneEl.value && emailEl.value && consentEl.checked && serviceTypeEl.value);}
  
  // KI Session starten
  startKiBtn.addEventListener("click", async ()=>{
    customerModal.style.display="none";
    kiModal.style.display="flex";
    messagesEl.innerHTML="";
    uploadedImages = [];
    addMessage("KI: Hallo! Ich werde Ihr Problem analysieren und wichtige Informationen sammeln.","ai");

    const service = serviceTypeEl.value;
    let problemText = "";

    // Bilder Upload vorbereiten
    fileInputKI.addEventListener("change", (e)=>{
      Array.from(e.target.files).forEach(file=>{
        uploadedImages.push(file.name)
        addMessage("Bild hochgeladen: "+file.name,"user")
        setTimeout(()=>{addMessage("KI: Bild erhalten und analysiert.","ai")},500)
      })
    })

    const questions={
      electricity:["Ist der FI-Schalter ausgelöst?","Ist eine Sicherung durchgebrannt?","Komplettausfall vorhanden?","Hören Sie ungewöhnliche Geräusche oder Funken?"],
      water:["Gibt es einen Rohrbruch oder ein Leck?","Kein Wasser vorhanden?","Tropft irgendwo Wasser?","Pumpe defekt?"],
      heating:["Heizung kalt?","Thermostat defekt?","Warmwasser funktioniert nicht?","Heizung ungleichmäßig?"]
    }

    for(let q of questions[service]){
      addMessage("KI: "+q,"ai");
      const answer = await new Promise(resolve=>{
        const handler = ()=>{
          if(userInputEl.value.trim()!==""){
            const val=userInputEl.value
            addMessage(val,"user")
            userInputEl.value=""
            resolve(val)
            sendBtn.removeEventListener("click",handler)
          }
        }
        sendBtn.addEventListener("click",handler)
      })
      problemText += q+": "+answer+"\n"
    }

    addMessage("KI: Vielen Dank. Ich habe alle wichtigen Informationen erfasst.","ai")

    // Supabase speichern
    const { data, error } = await supabase.from('ki_notdienst').insert([{
      name:nameEl.value,
      email:emailEl.value,
      telefon:phoneEl.value,
      adresse:addressEl.value,
      service:service,
      problem:problemText,
      image_paths:JSON.stringify(uploadedImages)
    }])
    if(error) console.error("Supabase Error:",error)
    else console.log("Daten gespeichert:",data)

    // WhatsApp Button anzeigen
    bookVideoCallBtn.style.display="block"
    bookVideoCallBtn.onclick = ()=>{
      const whatsappNumber="4915145932462"
      const message=`Ich möchte einen Live-Video-Call für den Notdienst buchen. Service: ${service}, Problem: ${problemText}`
      window.open(`https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`,"_blank")
    }
  })
})

function addMessage(content,sender){const div=document.createElement("div");div.className="message "+sender;div.innerText=content;messagesEl.appendChild(div);messagesEl.scrollTop=messagesEl.scrollHeight;}
</script>
</body>
</html>
